import { isPlatformServer } from '@angular/common';
import { Hooks } from '../types';
import { addCssClassName, cssClassNames, hasCssClassName, removeCssClassName } from '../util/css.util';
import { isChildOfPicture, isImageElement, setImage, setImageAndSourcesToDefault, setImageAndSourcesToError, setImageAndSourcesToLazy, setSourcesToLazy } from '../util/util';
export class SharedHooks extends Hooks {
    setup(attributes) {
        setImageAndSourcesToDefault(attributes.element, attributes.defaultImagePath, attributes.useSrcset);
        addCssClassName(attributes.element, cssClassNames.loading);
        if (hasCssClassName(attributes.element, cssClassNames.loaded)) {
            removeCssClassName(attributes.element, cssClassNames.loaded);
        }
    }
    finally(attributes) {
        addCssClassName(attributes.element, cssClassNames.loaded);
        removeCssClassName(attributes.element, cssClassNames.loading);
    }
    loadImage(attributes) {
        if (this.skipLazyLoading(attributes)) {
            // Set the image right away for bots for better SEO
            return [attributes.imagePath];
        }
        const { element, useSrcset, imagePath, decode } = attributes;
        let img;
        if (isImageElement(element) && isChildOfPicture(element)) {
            const parentClone = element.parentNode.cloneNode(true);
            img = parentClone.getElementsByTagName('img')[0];
            setSourcesToLazy(img);
            setImage(img, imagePath, useSrcset);
        }
        else {
            img = new Image();
            if (isImageElement(element) && element.referrerPolicy) {
                img.referrerPolicy = element.referrerPolicy;
            }
            if (isImageElement(element) && element.sizes) {
                img.sizes = element.sizes;
            }
            if (useSrcset && 'srcset' in img) {
                img.srcset = imagePath;
            }
            else {
                img.src = imagePath;
            }
        }
        if (decode && img.decode) {
            return img.decode().then(() => imagePath);
        }
        return new Promise((resolve, reject) => {
            img.onload = () => resolve(imagePath);
            img.onerror = () => reject(null);
        });
    }
    setErrorImage(error, attributes) {
        const { element, useSrcset, errorImagePath } = attributes;
        setImageAndSourcesToError(element, errorImagePath, useSrcset);
        addCssClassName(element, cssClassNames.failed);
    }
    setLoadedImage(imagePath, attributes) {
        const { element, useSrcset } = attributes;
        setImageAndSourcesToLazy(element, imagePath, useSrcset);
    }
    isDisabled() {
        // Disable if SSR and the user isn't a bot
        return isPlatformServer(this.platformId) && !this.isBot();
    }
    skipLazyLoading(attributes) {
        return this.isBot(attributes);
    }
    isBot(attributes) {
        var _a;
        if ((_a = this.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) {
            return /googlebot|bingbot|yandex|baiduspider|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora\ link\ preview|showyoubot|outbrain|pinterest\/0\.|pinterestbot|slackbot|vkShare|W3C_Validator|whatsapp|duckduckbot/i.test(this.navigator.userAgent);
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9va3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vIiwic291cmNlcyI6WyJzcmMvc2hhcmVkLWhvb2tzL2hvb2tzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRW5ELE9BQU8sRUFBYyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDdkcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsMkJBQTJCLEVBQUUseUJBQXlCLEVBQUUsd0JBQXdCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFOUssTUFBTSxPQUFnQixXQUFlLFNBQVEsS0FBUTtJQUNuRCxLQUFLLENBQUMsVUFBc0I7UUFDMUIsMkJBQTJCLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ25HLGVBQWUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUzRCxJQUFJLGVBQWUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUM3RCxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUM5RDtJQUNILENBQUM7SUFFRCxPQUFPLENBQUMsVUFBc0I7UUFDNUIsZUFBZSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFELGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxTQUFT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QixVQUFJLElBQUksQ0FBQyxTQUFTLDBDQUFFLFNBQVMsRUFBRTtZQUM3QixPQUFPLDROQUE0TixDQUFDLElBQUksQ0FDdE8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQ3pCLENBQUM7U0FDSDtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNQbGF0Zm9ybVNlcnZlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlSW5wdXQgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEF0dHJpYnV0ZXMsIEhvb2tzIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgYWRkQ3NzQ2xhc3NOYW1lLCBjc3NDbGFzc05hbWVzLCBoYXNDc3NDbGFzc05hbWUsIHJlbW92ZUNzc0NsYXNzTmFtZSB9IGZyb20gJy4uL3V0aWwvY3NzLnV0aWwnO1xuaW1wb3J0IHsgaXNDaGlsZE9mUGljdHVyZSwgaXNJbWFnZUVsZW1lbnQsIHNldEltYWdlLCBzZXRJbWFnZUFuZFNvdXJjZXNUb0RlZmF1bHQsIHNldEltYWdlQW5kU291cmNlc1RvRXJyb3IsIHNldEltYWdlQW5kU291cmNlc1RvTGF6eSwgc2V0U291cmNlc1RvTGF6eSB9IGZyb20gJy4uL3V0aWwvdXRpbCc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTaGFyZWRIb29rczxFPiBleHRlbmRzIEhvb2tzPEU+IHtcbiAgc2V0dXAoYXR0cmlidXRlczogQXR0cmlidXRlcyk6IHZvaWQge1xuICAgIHNldEltYWdlQW5kU291cmNlc1RvRGVmYXVsdChhdHRyaWJ1dGVzLmVsZW1lbnQsIGF0dHJpYnV0ZXMuZGVmYXVsdEltYWdlUGF0aCwgYXR0cmlidXRlcy51c2VTcmNzZXQpO1xuICAgIGFkZENzc0NsYXNzTmFtZShhdHRyaWJ1dGVzLmVsZW1lbnQsIGNzc0NsYXNzTmFtZXMubG9hZGluZyk7XG5cbiAgICBpZiAoaGFzQ3NzQ2xhc3NOYW1lKGF0dHJpYnV0ZXMuZWxlbWVudCwgY3NzQ2xhc3NOYW1lcy5sb2FkZWQpKSB7XG4gICAgICByZW1vdmVDc3NDbGFzc05hbWUoYXR0cmlidXRlcy5lbGVtZW50LCBjc3NDbGFzc05hbWVzLmxvYWRlZCk7XG4gICAgfVxuICB9XG5cbiAgZmluYWxseShhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVzKTogdm9pZCB7XG4gICAgYWRkQ3NzQ2xhc3NOYW1lKGF0dHJpYnV0ZXMuZWxlbWVudCwgY3NzQ2xhc3NOYW1lcy5sb2FkZWQpO1xuICAgIHJlbW92ZUNzc0NsYXNzTmFtZShhdHRyaWJ1dGVzLmVsZW1lbnQsIGNzc0NsYXNzTmFtZXMubG9hZGluZyk7XG4gIH1cblxuICBsb2FkSW1hZ2UoYXR0cmlidXRlczogQXR0cmlidXRlcyk6IE9ic2VydmFibGVJbnB1dDxzdHJpbmc+IHtcbiAgICBpZiAodGhpcy5za2lwTGF6eUxvYWRpbmcoYXR0cmlidXRlcykpIHtcbiAgICAgIC8vIFNldCB0aGUgaW1hZ2UgcmlnaHQgYXdheSBmb3IgYm90cyBmb3IgYmV0dGVyIFNFT1xuICAgICAgcmV0dXJuIFthdHRyaWJ1dGVzLmltYWdlUGF0aF07XG4gICAgfVxuICAgIGNvbnN0IHsgZWxlbWVudCwgdXNlU3Jjc2V0LCBpbWFnZVBhdGgsIGRlY29kZSB9ID0gYXR0cmlidXRlcztcbiAgICBsZXQgaW1nOiBIVE1MSW1hZ2VFbGVtZW50O1xuICAgIGlmIChpc0ltYWdlRWxlbWVudChlbGVtZW50KSAmJiBpc0NoaWxkT2ZQaWN0dXJlKGVsZW1lbnQpKSB7XG4gICAgICBjb25zdCBwYXJlbnRDbG9uZSA9IGVsZW1lbnQucGFyZW50Tm9kZSEuY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxQaWN0dXJlRWxlbWVudDtcbiAgICAgIGltZyA9IHBhcmVudENsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbWcnKVswXTtcbiAgICAgIHNldFNvdXJjZXNUb0xhenkoaW1nKTtcbiAgICAgIHNldEltYWdlKGltZywgaW1hZ2VQYXRoLCB1c2VTcmNzZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgIGlmIChpc0ltYWdlRWxlbWVudChlbGVtZW50KSAmJiBlbGVtZW50LnJlZmVycmVyUG9saWN5KSB7XG4gICAgICAgIGltZy5yZWZlcnJlclBvbGljeSA9IGVsZW1lbnQucmVmZXJyZXJQb2xpY3k7XG4gICAgICB9XG4gICAgICBpZiAoaXNJbWFnZUVsZW1lbnQoZWxlbWVudCkgJiYgZWxlbWVudC5zaXplcykge1xuICAgICAgICBpbWcuc2l6ZXMgPSBlbGVtZW50LnNpemVzO1xuICAgICAgfVxuICAgICAgaWYgKHVzZVNyY3NldCAmJiAnc3Jjc2V0JyBpbiBpbWcpIHtcbiAgICAgICAgaW1nLnNyY3NldCA9IGltYWdlUGF0aDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGltZy5zcmMgPSBpbWFnZVBhdGg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGRlY29kZSAmJiBpbWcuZGVjb2RlKSB7XG4gICAgICByZXR1cm4gaW1nLmRlY29kZSgpLnRoZW4oKCkgPT4gaW1hZ2VQYXRoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpbWcub25sb2FkID0gKCkgPT4gcmVzb2x2ZShpbWFnZVBhdGgpO1xuICAgICAgaW1nLm9uZXJyb3IgPSAoKSA9PiByZWplY3QobnVsbCk7XG4gICAgfSk7XG4gIH1cblxuICBzZXRFcnJvckltYWdlKGVycm9yOiBFcnJvciwgYXR0cmlidXRlczogQXR0cmlidXRlcyk6IHZvaWQge1xuICAgIGNvbnN0IHsgZWxlbWVudCwgdXNlU3Jjc2V0LCBlcnJvckltYWdlUGF0aCB9ID0gYXR0cmlidXRlcztcbiAgICBzZXRJbWFnZUFuZFNvdXJjZXNUb0Vycm9yKGVsZW1lbnQsIGVycm9ySW1hZ2VQYXRoLCB1c2VTcmNzZXQpO1xuICAgIGFkZENzc0NsYXNzTmFtZShlbGVtZW50LCBjc3NDbGFzc05hbWVzLmZhaWxlZCk7XG4gIH1cblxuICBzZXRMb2FkZWRJbWFnZShpbWFnZVBhdGg6IHN0cmluZywgYXR0cmlidXRlczogQXR0cmlidXRlcyk6IHZvaWQge1xuICAgIGNvbnN0IHsgZWxlbWVudCwgdXNlU3Jjc2V0IH0gPSBhdHRyaWJ1dGVzO1xuICAgIHNldEltYWdlQW5kU291cmNlc1RvTGF6eShlbGVtZW50LCBpbWFnZVBhdGgsIHVzZVNyY3NldCk7XG4gIH1cblxuICBpc0Rpc2FibGVkKCk6IGJvb2xlYW4ge1xuICAgIC8vIERpc2FibGUgaWYgU1NSIGFuZCB0aGUgdXNlciBpc24ndCBhIGJvdFxuICAgIHJldHVybiBpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkgJiYgIXRoaXMuaXNCb3QoKTtcbiAgfVxuXG4gIHNraXBMYXp5TG9hZGluZyhhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNCb3QoYXR0cmlidXRlcyk7XG4gIH1cblxuICBpc0JvdChhdHRyaWJ1dGVzPzogQXR0cmlidXRlcyk6IGJvb2xlYW4ge1xuICAgIGlmICh0aGlzLm5hdmlnYXRvcj8udXNlckFnZW50KSB7XG4gICAgICByZXR1cm4gL2dvb2dsZWJvdHxiaW5nYm90fHlhbmRleHxiYWlkdXNwaWRlcnxmYWNlYm9va2V4dGVybmFsaGl0fHR3aXR0ZXJib3R8cm9nZXJib3R8bGlua2VkaW5ib3R8ZW1iZWRseXxxdW9yYVxcIGxpbmtcXCBwcmV2aWV3fHNob3d5b3Vib3R8b3V0YnJhaW58cGludGVyZXN0XFwvMFxcLnxwaW50ZXJlc3Rib3R8c2xhY2tib3R8dmtTaGFyZXxXM0NfVmFsaWRhdG9yfHdoYXRzYXBwfGR1Y2tkdWNrYm90L2kudGVzdChcbiAgICAgICAgdGhpcy5uYXZpZ2F0b3IudXNlckFnZW50XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbiJdfQ==